@using CSS_Server.Models.Authentication
@using CSS_Server.ViewModels
@using CSS_Server.Models

@{
    Layout = "_Layout";
}

@model List<User>

<main class="main_dashboard">
    <button class="addButton" title="Register a new user" onclick="location.href='@Url.Action("Register", "Account")'">+</button>
    <h1>Users</h1>

    <table>
        <thead>
            <tr>
                <td>ID</td><td>Email</td><td>UserName</td><td>Actions</td>
            </tr>
        </thead>
        <tbody>
        @foreach (User user in Model)
        {
            <tr><td>@user.Id</td><td>@user.Email</td><td>@user.UserName</td><td><span class="trashbin"></span><span class="pencil"></span></td></tr>
        }
    </tbody>
    </table>
    
    <div id="snackbar"></div>
</main>

<script>
    function pencilOnClick(event, userId){
        console.log("pencil is clicked", userId);
    }

    function showSnackbar(time){
        var snackbar = document.getElementById("snackbar");
        snackbar.className = "show";
        setTimeout(function(){ snackbar.className = snackbar.className.replace("show", ""); }, time);
    }

    //This function will be executed when the trashbin icon is clicked.
    function trashbinOnClick(event, userRow, userId){
        if(confirm("Are you sure you want to delete the user?")){
            var url = "@(Url.Action("Delete", "Account"))" + "/" + userId;
            var xhr = new XMLHttpRequest();
            xhr.open("DELETE", url);

            //define a function for letting the user know that the user is deleted succesfully (or not).
            xhr.onload = function(){
                var snackbar = document.getElementById("snackbar");
                if(xhr.status == 200){
                    snackbar.innerText = "User was deleted succesfully!"
                    userRow.remove();
                } else {
                    snackbar.innerText = "User was not deleted succesfully!"
                }
                showSnackbar(3000);
            };

            xhr.send(null);
        }
    }

    //Get all userrows from the table.
    var userRows = document.querySelectorAll("tbody > tr");
    Array.from(userRows).forEach(function(userRow){
        //Get user id by getting the innerText from the first td.
        var userId = userRow.querySelector("td").innerText;

        //Get the trashbin icon and add an eventlistener to it.
        userRow.querySelector(".trashbin").addEventListener("click", trashbinOnClick.bind(null, event, userRow, userId));

        //Get the pencil icon and add an eventlistener to it.
        userRow.querySelector(".pencil").addEventListener("click", pencilOnClick.bind(null, event, userId));
    });
</script>
